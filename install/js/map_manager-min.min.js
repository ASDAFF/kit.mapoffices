/*
 * Copyright (c) 7/10/2020 Created By/Edited By ASDAFF asdaff.asad@yandex.ru
 */

(function(f){if(f.BX.KITMapOfficesMap){return}var b=f.BX,d={debug:false,map:"KIT_MapOffice_YMAP",map_center:[0,0],map_zoom:2,auto_zoom_correct:-1,city_id:-1,selector_office_block:"selector-office",ymap_api_error:'Yandex Maps script is not connected to the page. Please check the component option "Connect script download Yandex maps 2.0" should be checked.',ymaps_ready:function(){},create_placemark:function(){},action_traffic:function(){},action_map:function(){},select_city:function(){},select_point:function(){}},c={},e={},h=Object,a=Object,g=false,i;b.KITMapOfficesMap=function(n,m){var z=function(){};this.data=n;this.attr_action="map-action";this.ready=function(A){if(typeof A=="function"){z=A}};this.actions={traffic:["toggle","show","hide"],map:["setDefault","setCity","setOffice"]};this.Action=function(A,B){if(typeof A!="string"){return false}if(typeof B=="undefined"){j(A)}else{j(A,B)}};var q=this;c=m;for(var o in d){if(typeof(m[o])=="undefined"){c[o]=d[o]}}if(c.debug){console.log("config",c)}if(typeof c.map!="string"||c.map.length==0){return false}if(typeof c.selector_office_block!="string"){return false}if(typeof c.ymap_api_error!="string"){c.ymap_api_error=""}c.city_id=c.city_id-0;this.controls=b.findChild(document,{attr:q.attr_action},true,true);for(o in q.controls){var s=false,r="",u=-1;if(typeof q.controls[o]=="undefined"){continue}r=q.controls[o].getAttribute(q.attr_action);for(t in q.actions){var y=new RegExp("^"+t+".","g"),u=r.search(y);if(u===0){break}}if(u!==0){continue}(function(B,A){if(B.tagName=="SELECT"){b.bind(B,"change",function(C){var D=this.options[this.selectedIndex].value-0;j(A,D);b.PreventDefault(C);return false})}else{b.bind(B,"click",function(C){var D=this.getAttribute("data-id")-0;j(A,D);b.PreventDefault(C);return false})}})(q.controls[o],r)}if(typeof ymaps!="undefined"){ymaps.ready(function(){h=new ymaps.Map(c.map,{center:c.map_center,zoom:c.map_zoom}),a=new ymaps.GeoObjectCollection();if(c.city_id>=0){var B=x(c.city_id);c.map_center=B[0];c.map_zoom=B[1]}else{var B=GetCityPosition(h,0);c.map_center=B[0];c.map_zoom=B[1]}h.setCenter(c.map_center);h.setZoom(7);v(c.map_center,c.map_zoom,0,500,0);i=new ymaps.traffic.provider.Actual({},{infoLayerShown:true});h.events.add("boundschange",function(E){var H=1e-9;var G=E.originalEvent.newCenter[0]-c.map_center[0];var F=E.originalEvent.newCenter[1]-c.map_center[1];if(c.debug){console.log("YMap.events boundschange ","delta_x = "+G," delta_y = "+F,"delta = "+H)}if(c.debug){console.log("YMap.events boundschange ","newZoom = "+E.get("newZoom")," oldZoom = "+E.get("oldZoom"),"map_zoom = "+c.map_zoom)}if(Math.abs(G)>H||Math.abs(F)>H||(E.get("newZoom")!=E.get("oldZoom")&&E.get("newZoom")!=c.map_zoom)){if(c.debug){console.log("controls map.setDefault show")}var D=l("map.setDefault",function(I){b.show(b(I))})}else{var D=l("map.setDefault",function(I){b.hide(b(I))})}});l("map.setDefault",function(D){b.hide(b(D))});w(n);h.geoObjects.add(a);for(k in q.controls){var A=q.controls[k].getAttribute("map-action");var C=q.controls[k].getAttribute("data-id")-0;if(A!="map.setOffice"||C<=0||typeof n[C]!="object"){continue}(function(E,D){b.bind(q.controls[k],"click",function(F){v(D.center,15);if(typeof c.select_point=="function"){c.select_point(E,D)}b.PreventDefault(F);return false})})(C,n[C])}if(typeof c.ymaps_ready=="function"){c.ymaps_ready(h,a,this.data)}if(typeof z=="function"){z(q)}})}else{alert(c.ymap_api_error)}var l=function(C,E){var D=[];for(o in q.controls){var A="",B=new RegExp("^"+C,"i");if(typeof q.controls[o]=="undefined"){continue}A=q.controls[o].getAttribute(q.attr_action);if(A.search(B)===0&&A!=null){D.push(q.controls[o]);if(typeof E=="function"){E(q.controls[o])}}}return D};var j=function(B,D){var A=B.split(".");if(A.length!=2){return false}if(typeof D!="number"||D<1){D=0}if(A[0]=="traffic"){if(typeof q.actions.traffic!="object"){return false}switch(A[1]){case"toggle":q.traffic_status=q.traffic_status?false:true;break;case"show":q.traffic_status=true;break;case"hide":q.traffic_status=false;break}var C=l(A[0]+".",function(E){});if(h){if(q.traffic_status){i.setMap(h)}else{i.setMap(null)}}if(typeof c.action_traffic=="function"){c.action_traffic(A[1],q.traffic_status,C)}}else{if(A[0]=="map"){switch(A[1]){case"setDefault":if(c.city_id>0){x(c.city_id)}else{v(c.map_center,c.map_zoom)}break;case"setCity":if(D>0){x(D)}break;case"setOffice":break}if(typeof c.action_map=="function"){c.action_map(A[1])}}}};GetCityPosition=function(B,F){var C=1,A=[0,0],E=[];for(o in n){if((n[o]["city"]==F||F==0)&&n[o]["center"].length==2&&typeof n[o]["center"]=="object"){E.push(new ymaps.Placemark(n[o]["center"]))}}if(typeof E!="object"||E.length==0){return[A,Math.ceil(C)]}var D=ymaps.geoQuery(E);C=D.getMaxZoom(B)+c.auto_zoom_correct;A=D.getCenter(B);C=C>16?16:C;C=C<=0?1:C;return[A,Math.ceil(C)]};var x=function(H,G){if(H>0){var C=l("map.setCity",function(I){b.removeClass(I,"active")});for(o in C){var B=C[o].getAttribute("data-id");if(C[o].tagName=="SELECT"){var A=-1;var E=C[o].options;for(k in C[o].options){if(C[o].options[k].value==H){A=k}}C[o].options[A].selected=true}else{if(B==H){b.addClass(C[o],"active")}}}var D=b.findChild(document,{className:c.selector_office_block},true,true);for(k in D){if(k!="indexOf"&&typeof D[k]=="object"){b.hide(D[k])}}D=b.findChild(document,{className:c.selector_office_block,attr:{"data-city":H}},true,true);for(k in D){if(k!="indexOf"&&typeof D[k]=="object"){b.show(D[k])}}}var F=GetCityPosition(h,H);v(F[0],F[1]);if(typeof c.select_city=="function"){c.select_city(C,H,F[0],F[1],n)}return F};var p=function(A){var C=null;if(A.center.length!=2||typeof A.center!="object"){return false}if(typeof c.create_placemark=="function"){C=c.create_placemark(A)}if(typeof C.data!="object"){C.data=Object}if(typeof C.options!="object"){C.options=Object}var B=new ymaps.Placemark(A.center,C.data,C.options);return B};var w=function(B){for(index in B){var A=p(B[index]);if(A===false){continue}a.add(A)}};var v=function(B,D,E,A,C){if(c.debug){console.log("panTo")}if(typeof E!="number"){E=1000}if(typeof A!="number"){A=1000}if(typeof C!="number"){C=500}h.panTo(B,{flying:true,duration:E,delay:C,callback:function(F){if(F){alert("Error: Could not display the specified region")}h.setZoom(D,{duration:A})}})};return this}})(window);